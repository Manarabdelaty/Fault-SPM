
/*
    Automatically generated by Fault
    Do not modify.
    Generated on: 2021-01-29 09:41:02
*/
`include "libs.ref/sky130_fd_sc_hd/verilog/primitives.v"
`include "libs.ref/sky130_fd_sc_hd/verilog/sky130_fd_sc_hd.v"

`ifdef GL
    `include "gl/spm_top.v"
`else
    `include "dft/2-spm_top.tap.v"
`endif

module testbench;
    reg[0:0] \tms ;
    reg[0:0] \trst ;
    reg[0:0] \start ;
    reg[0:0] \rst ;
    wire[0:0] \tdo_paden_o ;
    reg[31:0] \mc ;
    wire[0:0] \done ;
    reg[0:0] \clk ;
    reg[31:0] \mp ;
    wire[63:0] \prod ;
    reg[0:0] \tck ;
    wire[0:0] \tdo ;
    reg[0:0] \tdi ;

    
    always #1 clk = ~clk;
    always #1 tck = ~tck;

    spm_top uut(
    `ifdef USE_POWER_PINS
        .VPWR(1'b1),
        .VGND(1'b0),
    `endif
        .\tms ( \tms ) , .\trst ( \trst ) , .\start ( \start ) , .\rst ( \rst ) , .\tdo_paden_o ( \tdo_paden_o ) , .\mc ( \mc ) , .\done ( \done ) , .\clk ( \clk ) , .\mp ( \mp ) , .\prod ( \prod ) , .\tck ( \tck ) , .\tdo ( \tdo ) , .\tdi ( \tdi ) 
    );

    integer i, error;

    reg [266:0] scanInSerial;
    reg [266:0] vectors [0:9];
    reg [266:0] gmOutput[0:9];

    wire[7:0] tmsPattern = 8'b 01100110;
    wire[3:0] preloadChain = 4'b 0011;

    initial begin
        // $dumpfile("dut.vcd"); // DEBUG
        // $dumpvars(0, testbench);
        \clk = 1 ;
        \rst = 1 ;
        \mc = 0 ;
        \mp = 0 ;
        \clk = 0 ;
        \rst = 1 ;
        \start = 0 ;
        \tms = 1 ;
        \tck = 0 ;
        \tdi = 0 ;
        \trst = 0 ;

        $readmemb("spm_top.bin.vec.bin", vectors);
        $readmemb("spm_top.bin.out.bin", gmOutput);
        #2;
        rst = ~rst;
        trst = 1;        
        #2;
        test(vectors[0], gmOutput[0]) ;
        test(vectors[1], gmOutput[1]) ;
        test(vectors[2], gmOutput[2]) ;
        test(vectors[3], gmOutput[3]) ;
        test(vectors[4], gmOutput[4]) ;
        test(vectors[5], gmOutput[5]) ;
        test(vectors[6], gmOutput[6]) ;
        test(vectors[7], gmOutput[7]) ;
        test(vectors[8], gmOutput[8]) ;
        test(vectors[9], gmOutput[9]) ;

        $display("SUCCESS_STRING");
        $finish;
    end

    task test;
        input [266:0] vector;
        input [266:0] goldenOutput;
        begin
           
            // Preload Scan-Chain with TV

            shiftIR(preloadChain);
            enterShiftDR();

            for (i = 0; i < 267; i = i + 1) begin
                tdi = vector[i];
                if (i == 264) begin
                    tms = 1; // Exit-DR
                end
                if (i == 265) begin
                    tms = 0; // Pause-DR
                end
                if (i == 266) begin
                    tms = 1; // Exit2-DR
                end
                #2;
            end

            tms = 0; // Shift-DR
            #2;
            // Shift-out response
            error = 0;
            for (i = 0; i< 267;i = i + 1) begin
                tdi = 0;
                scanInSerial[i] = tdo;
                if (scanInSerial[i] !== goldenOutput[i]) begin
                    $display("Error simulating output response at bit number %0d                        Expected %0b, Got %0b", i, goldenOutput[i], scanInSerial[i]);
                    error = error + 1;
                end
                if(i == 266) begin
                    tms = 1; // Exit-DR
                end
                #2;
            end
            tms = 1; // update-DR
            #2;
            tms = 0; // run-test-idle
            #2;

            if(scanInSerial !== goldenOutput) begin
                $display("Simulating TV failed, number fo errors %0d : ", error);
                $error("SIMULATING_TV_FAILED");
                $finish;
            end
        end
    endtask

       task shiftIR;
        input[3:0] instruction;
        integer i;
        begin
            for (i = 0; i< 5; i = i + 1) begin
                tms = tmsPattern[i];
                #2;
            end

            // At shift-IR: shift new instruction on tdi line
            for (i = 0; i < 4; i = i + 1) begin
                tdi = instruction[i];
                if(i == 3) begin
                    tms = tmsPattern[5];     // exit-ir
                end
                #2;
            end

            tms = tmsPattern[6];     // update-ir 
            #2;
            tms = tmsPattern[7];     // run test-idle
            #6;
        end
    endtask

    task enterShiftDR;
        begin
            tms = 1;     // select DR
            #2;
            tms = 0;     // capture DR -- shift DR
            #4;
        end
    endtask

    task exitDR;
        begin
            tms = 1;     // Exit DR -- update DR
            #4;
            tms = 0;     // Run test-idle
            #2;
        end
    endtask
endmodule
